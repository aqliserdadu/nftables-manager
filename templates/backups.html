{% extends "base.html" %}

{% block title %}Backup Management{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-clock-history"></i> Backup Management</h2>
    <div>
        <a href="{{ url_for('debug_backup') }}" class="btn btn-info me-2">
            <i class="bi bi-bug"></i> Debug Backup
        </a>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Configuration Backups</h5>
    </div>
    <div class="card-body">
        {% if backups %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Backup Name</th>
                        <th>Created</th>
                        <th>Size</th>
                        <th>Contents</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for backup in backups %}
                    <tr>
                        <td>
                            <strong>{{ backup.name }}</strong>
                            <br>
                            <small class="text-muted">{{ backup.path }}</small>
                        </td>
                        <td>{{ backup.created.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td>{{ "%.2f"|format(backup.size / 1024) }} KB</td>
                        <td>
                            {% if backup.has_nftables %}
                                <span class="badge bg-success">nftables</span>
                            {% else %}
                                <span class="badge bg-secondary">nftables</span>
                            {% endif %}
                            
                            {% if backup.has_db %}
                                <span class="badge bg-primary">Database</span>
                            {% else %}
                                <span class="badge bg-secondary">Database</span>
                            {% endif %}
                            
                            {% if backup.has_info %}
                                <span class="badge bg-info">Info</span>
                            {% else %}
                                <span class="badge bg-secondary">Info</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('restore_backup', backup_name=backup.name) }}" 
                                   class="btn btn-sm btn-primary"
                                   onclick="return confirm('Are you sure you want to restore this backup? This will replace both the configuration and database.')"
                                   title="Restore backup">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </a>
                                <a href="{{ url_for('delete_backup_route', backup_name=backup.name) }}" 
                                   class="btn btn-sm btn-danger"
                                   onclick="return confirm('Are you sure you want to delete this backup? This action cannot be undone.')"
                                   title="Delete backup">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Bulk Actions -->
        <div class="mt-3">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <small class="text-muted">
                        Showing {{ backups|length }} backup{{ 's' if backups|length != 1 else '' }}
                    </small>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteOldBackups()">
                        <i class="bi bi-trash"></i> Delete Backups Older Than 30 Days
                    </button>
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-folder-x display-1 text-muted"></i>
            <h4 class="mt-3">No backups found</h4>
            <p class="text-muted">Backups are created automatically when you apply rules</p>
            <div class="mt-3">
                <button class="btn btn-primary" onclick="createManualBackup()">
                    <i class="bi bi-plus-circle"></i> Create Manual Backup
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="card shadow">
    <div class="card-header">
        <h5 class="card-title mb-0">Backup Information</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>Backup Directory:</h6>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" value="{{ backup_dir }}" readonly>
                    <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ backup_dir }}')">
                        <i class="bi bi-clipboard"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <h6>Backup Process:</h6>
                <p class="text-muted">
                    Each backup contains both the nftables configuration file and the database. 
                    This ensures that when you restore, both the system configuration and the web interface data are restored.
                </p>
            </div>
        </div>
        
        <h6 class="mt-4">What's Included in Backup:</h6>
        <ul>
            <li><strong>nftables.conf</strong> - The current firewall configuration</li>
            <li><strong>firewall.db</strong> - The database containing all rules, groups, and users</li>
            <li><strong>backup_info.txt</strong> - Metadata about the backup</li>
        </ul>
        
        <h6 class="mt-4">Restore Process:</h6>
        <ol>
            <li>Creates a backup of the current configuration (safety backup)</li>
            <li>Restores the database file (firewall.db)</li>
            <li>Restores the nftables configuration file</li>
            <li>Reloads the nftables service</li>
            <li><strong>Note:</strong> You may need to restart the application to see the restored rules in the web interface</li>
        </ol>
        
        <h6 class="mt-4">Storage Management:</h6>
        <p class="text-muted">
            Backups can consume significant disk space over time. Use the delete buttons to remove old or unnecessary backups. 
            Consider keeping only the most recent backups and those taken before major configuration changes.
        </p>
    </div>
</div>

<!-- Modal for delete confirmation -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this backup?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> This action cannot be undone.
                </div>
                <p><strong>Backup:</strong> <span id="deleteBackupName"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            alert('Copied to clipboard!');
        }, function(err) {
            console.error('Could not copy text: ', err);
        });
    }
    
    function createManualBackup() {
        fetch('/api/create-backup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Backup created successfully!');
                location.reload();
            } else {
                alert('Failed to create backup: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating backup');
        });
    }
    
    function deleteOldBackups() {
        if (confirm('Are you sure you want to delete all backups older than 30 days?')) {
            fetch('/api/delete-old-backups', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Deleted ' + data.count + ' old backups!');
                    location.reload();
                } else {
                    alert('Failed to delete old backups: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting old backups');
            });
        }
    }
</script>
{% endblock %}