{% extends "base.html" %} {% block title %}Add Rule{% endblock %} {% block
content %}
<div class="row justify-content-center">
  <div class="col-md-10 col-lg-8">
    <div class="card shadow">
      <div class="card-body">
        <h3 class="card-title mb-4">
          <i class="bi bi-plus-circle"></i> Add Firewall Rule
        </h3>
        <form method="POST">
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="name" class="form-label">Rule Name *</label>
              <input
                type="text"
                class="form-control"
                id="name"
                name="name"
                required
              />
              <div class="form-text">
                Give your rule a descriptive name for easier troubleshooting
              </div>
            </div>
            <div class="col-md-6">
              <label for="group_id" class="form-label">Group</label>
              <select class="form-select" id="group_id" name="group_id">
                <option value="">-- No Group --</option>
                {% for group in groups %}
                <option value="{{ group.id }}">{{ group.name }}</option>
                {% endfor %}
              </select>
              <div class="form-text">Group rules for better organization</div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="chain" class="form-label">Chain *</label>
              <select class="form-select" id="chain" name="chain" required>
                <option value="input">Input</option>
                <option value="forward">Forward</option>
                <option value="output">Output</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="action" class="form-label">Action *</label>
              <select class="form-select" id="action" name="action" required>
                <option value="accept">Accept</option>
                <option value="drop">Drop</option>
                <option value="reject">Reject</option>
              </select>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="src" class="form-label">Source Address</label>
              <input
                type="text"
                class="form-control"
                id="src"
                name="src"
                placeholder="e.g., 192.168.1.0/24"
              />
            </div>
            <div class="col-md-6">
              <label for="dst" class="form-label">Destination Address</label>
              <input
                type="text"
                class="form-control"
                id="dst"
                name="dst"
                placeholder="e.g., 10.0.0.1"
              />
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="protocol" class="form-label">Protocol</label>
              <select class="form-select" id="protocol" name="protocol">
                <option value="">Any</option>
                <option value="tcp">TCP</option>
                <option value="udp">UDP</option>
                <option value="icmp">ICMP</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="dport" class="form-label">Destination Port</label>
              <input
                type="text"
                class="form-control"
                id="dport"
                name="dport"
                placeholder="e.g., 22, 80, 443"
              />
            </div>
          </div>

          <div class="mb-3">
            <label for="comment" class="form-label">Comment</label>
            <textarea
              class="form-control"
              id="comment"
              name="comment"
              rows="2"
            ></textarea>
          </div>

          <div class="mb-3">
            <div class="form-check">
              <input
                class="form-check-input"
                type="checkbox"
                id="has_expiry"
                name="has_expiry"
              />
              <label class="form-check-label" for="has_expiry">
                Set Expiry Date & Time
              </label>
            </div>
            <div id="expiry_fields" style="display: none; margin-top: 10px">
              <div class="row">
                <div class="col-md-6">
                  <label for="expired_date" class="form-label"
                    >Expiry Date</label
                  >
                  <input
                    type="date"
                    class="form-control"
                    name="expired_date"
                    id="expired_date"
                    min="{{ datetime.now().strftime('%Y-%m-%d') }}"
                  />
                </div>
                <div class="col-md-6">
                  <label for="expired_time" class="form-label"
                    >Expiry Time</label
                  >
                  <input
                    type="time"
                    class="form-control"
                    name="expired_time"
                    id="expired_time"
                  />
                </div>
              </div>
              <small class="form-text text-muted"
                >Rule will be automatically disabled when expired</small
              >
            </div>
          </div>

          <div class="mb-4 form-check">
            <input
              type="checkbox"
              class="form-check-input"
              id="enabled"
              name="enabled"
              checked
            />
            <label class="form-check-label" for="enabled"
              >Enable this rule</label
            >
          </div>

          <div class="d-flex justify-content-between">
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
              <i class="bi bi-arrow-left"></i> Cancel
            </a>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-circle"></i> Add Rule
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const hasExpiryCheckbox = document.getElementById("has_expiry");
    const expiryFields = document.getElementById("expiry_fields");
    const expiredDateInput = document.getElementById("expired_date");
    const expiredTimeInput = document.getElementById("expired_time");

    // Show/hide expiry fields based on checkbox
    hasExpiryCheckbox.addEventListener("change", function () {
      if (this.checked) {
        expiryFields.style.display = "block";
        // Set default time to 23:59 if not specified
        if (!expiredTimeInput.value) {
          expiredTimeInput.value = "23:59";
        }
      } else {
        expiryFields.style.display = "none";
        // Clear values when unchecked
        expiredDateInput.value = "";
        expiredTimeInput.value = "";
      }
    });

    // Set default time to 23:59 if date is selected
    expiredDateInput.addEventListener("change", function () {
      if (hasExpiryCheckbox.checked && !expiredTimeInput.value) {
        expiredTimeInput.value = "23:59";
      }
    });

    // Validate that time is set if date is set
    const form = document.querySelector("form");
    form.addEventListener("submit", function (event) {
      if (hasExpiryCheckbox.checked) {
        if (!expiredDateInput.value || !expiredTimeInput.value) {
          event.preventDefault();
          alert("Please select both expiry date and time when setting expiry.");
          if (!expiredDateInput.value) {
            expiredDateInput.focus();
          } else {
            expiredTimeInput.focus();
          }
        }
      }
    });
  });
</script>
{% endblock %}
